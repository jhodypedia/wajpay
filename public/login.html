<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Bot WhatsApp</title>
    <style>
        :root {
            --bg-color: #f0f2f5; --panel-bg: #ffffff; --border-color: #d1d7db;
            --text-primary: #111b21; --text-secondary: #667781;
            --accent-green: #00a884; --accent-blue: #34b7f1; --accent-red: #ea003a;
            --status-connected: #25d366; --status-disconnected: #ffc107; --status-loggedout: #dc3545;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0; background-color: var(--bg-color); color: var(--text-primary);
            display: flex; height: 100vh; overflow: hidden;
        }
        .sidebar {
            width: 300px; background-color: var(--panel-bg); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column;
        }
        .main-content {
            flex: 1; padding: 20px; overflow-y: auto;
        }
        .sidebar-header, .sidebar-sessions { padding: 15px; }
        .sidebar-header { border-bottom: 1px solid var(--border-color); }
        .sidebar-sessions { flex: 1; overflow-y: auto; }
        
        h1, h2, h3 { margin-top: 0; }
        h2 { font-size: 1.2em; }
        
        .session-list { list-style: none; padding: 0; margin: 0; }
        .session-item {
            padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .session-item:hover, .session-item.active { background-color: #f5f6f6; }
        .session-info .id { font-weight: bold; }
        .session-info .phone { font-size: 0.9em; color: var(--text-secondary); }
        .session-status { width: 12px; height: 12px; border-radius: 50%; }
        .status-connected { background-color: var(--status-connected); }
        .status-qr_received, .status-loading { background-color: var(--status-disconnected); }
        .status-disconnected, .status-logged_out { background-color: var(--status-loggedout); }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        input[type="text"], textarea {
            width: 100%; padding: 10px; box-sizing: border-box;
            border: 1px solid var(--border-color); border-radius: 6px;
        }
        textarea { resize: vertical; min-height: 80px; }
        button {
            padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer;
            background-color: var(--accent-green); color: white; font-weight: bold;
        }
        button.btn-danger { background-color: var(--accent-red); }
        button:disabled { background-color: #ccc; }

        .content-view { display: none; }
        .content-view.active { display: block; }

        #qr-view img { max-width: 300px; border: 1px solid var(--border-color); }
        #message-log {
            height: 300px; overflow-y: scroll; border: 1px solid var(--border-color);
            padding: 10px; background-color: #e9e9e9; border-radius: 6px;
        }
        .log-item { padding: 5px; border-bottom: 1px solid #ddd; font-size: 0.9em; }
        .log-item.out { text-align: right; color: #056162; }
        .log-item.in { color: #222; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Sesi WhatsApp</h2>
            <form id="new-session-form" class="form-group">
                <label for="session-id-input">ID Sesi Baru</label>
                <input type="text" id="session-id-input" placeholder="cth: marketing, cs-01" required>
                <button type="submit">Buat / Mulai</button>
            </form>
        </div>
        <div class="sidebar-sessions">
            <ul id="sessions-list" class="session-list">
                </ul>
        </div>
    </div>

    <div class="main-content">
        <div id="welcome-view" class="content-view active">
            <h1>Selamat Datang di Dasbor Bot</h1>
            <p>Silakan buat sesi baru atau pilih sesi yang sudah ada dari panel sebelah kiri untuk memulai.</p>
        </div>

        <div id="qr-view" class="content-view">
            <h2 id="qr-title">Scan QR Code</h2>
            <p>Buka WhatsApp Anda, pergi ke Perangkat Tertaut dan scan kode di bawah ini.</p>
            <img id="qr-image" src="" alt="QR Code akan muncul di sini">
        </div>

        <div id="messaging-view" class="content-view">
            <h2 id="messaging-title">Mengirim Pesan</h2>
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <h3>Kirim Pesan Tunggal</h3>
                    <form id="send-message-form">
                        <div class="form-group">
                            <label for="recipient-input">Nomor Tujuan</label>
                            <input type="text" id="recipient-input" placeholder="cth: 6281234567890" required>
                        </div>
                        <div class="form-group">
                            <label for="message-input">Pesan</label>
                            <textarea id="message-input" required></textarea>
                        </div>
                        <button type="submit">Kirim</button>
                    </form>
                </div>
                <div style="flex: 1;">
                    <h3>Kirim Broadcast</h3>
                    <form id="broadcast-form">
                         <div class="form-group">
                            <label for="broadcast-numbers">Daftar Nomor (satu per baris)</label>
                            <textarea id="broadcast-numbers" placeholder="6281...&#10;6282...&#10;6283..." required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="broadcast-message">Pesan Broadcast</label>
                            <textarea id="broadcast-message" required></textarea>
                        </div>
                        <button type="submit">Kirim Broadcast</button>
                    </form>
                </div>
            </div>
            <hr style="margin: 20px 0;">
            <h3>Log Pesan</h3>
            <div id="message-log"></div>
            <button id="logout-btn" class="btn-danger" style="margin-top: 20px;">Logout dari Sesi Ini</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io("http://localhost:3000"); // Ganti jika beda host/port

        // --- DOM Elements ---
        const sessionListUl = document.getElementById('sessions-list');
        const newSessionForm = document.getElementById('new-session-form');
        const contentViews = document.querySelectorAll('.content-view');
        const qrView = document.getElementById('qr-view');
        const qrImage = document.getElementById('qr-image');
        const qrTitle = document.getElementById('qr-title');
        const messagingView = document.getElementById('messaging-view');
        const messagingTitle = document.getElementById('messaging-title');
        const sendMessageForm = document.getElementById('send-message-form');
        const broadcastForm = document.getElementById('broadcast-form');
        const messageLog = document.getElementById('message-log');
        const logoutBtn = document.getElementById('logout-btn');

        let activeSessionId = null;

        // --- Helper Functions ---
        function switchView(viewId) {
            contentViews.forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        function logToPanel(text, type = 'in') {
            const item = document.createElement('div');
            item.className = `log-item ${type}`;
            item.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
            messageLog.appendChild(item);
            messageLog.scrollTop = messageLog.scrollHeight;
        }

        function renderSession(session) {
            let item = document.getElementById(`session-${session.session_id}`);
            if (!item) {
                item = document.createElement('li');
                item.id = `session-${session.session_id}`;
                item.className = 'session-item';
                item.dataset.sessionId = session.session_id;
            }

            item.innerHTML = `
                <div class="session-info">
                    <div class="id">${session.session_id}</div>
                    <div class="phone">${session.phone_number || 'Belum Terhubung'}</div>
                </div>
                <div id="status-${session.session_id}" class="session-status ${session.status}"></div>
            `;
            
            item.onclick = () => {
                activeSessionId = session.session_id;
                document.querySelectorAll('.session-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                if (session.status === 'connected') {
                    messagingTitle.textContent = `Mengirim Pesan (Sesi: ${activeSessionId})`;
                    messageLog.innerHTML = ''; // Clear log
                    switchView('messaging-view');
                } else if (session.status === 'qr_received' || session.status === 'loading') {
                     socket.emit('request-qr', { sessionId: activeSessionId });
                } else {
                    switchView('welcome-view');
                    alert(`Sesi ${activeSessionId} sedang ${session.status}. Silakan mulai sesi atau hubungkan kembali.`);
                }
            };
            
            return item;
        }

        // --- Socket.IO Event Listeners ---
        socket.on('connect', () => {
            console.log('Terhubung ke server via Socket.IO');
            socket.emit('list-sessions');
        });

        socket.on('sessions-list', (sessions) => {
            sessionListUl.innerHTML = '';
            sessions.forEach(session => {
                sessionListUl.appendChild(renderSession(session));
            });
        });

        socket.on('session', (session) => {
            const item = document.getElementById(`session-${session.session_id}`);
            const updatedItem = renderSession(session);
            if (item) {
                item.replaceWith(updatedItem);
            } else {
                sessionListUl.appendChild(updatedItem);
            }
        });

        socket.on('qr', ({ id, qr }) => {
            if(activeSessionId !== id && !document.getElementById(`session-${id}`)) {
                // if this is a new session we just created, auto-select it
                activeSessionId = id;
            }
            qrTitle.textContent = `Scan QR Code untuk Sesi: ${id}`;
            qrImage.src = qr;
            switchView('qr-view');
        });

        socket.on('ready', ({ id }) => {
            if (activeSessionId === id) {
                messagingTitle.textContent = `Mengirim Pesan (Sesi: ${activeSessionId})`;
                switchView('messaging-view');
            }
        });
        
        socket.on('message', ({ id, from, text }) => {
            if (activeSessionId === id) {
                 logToPanel(`Pesan dari ${from}: ${text}`, 'in');
            }
        });

        socket.on('message-sent', ({ id, to, message }) => {
            if (activeSessionId === id) {
                logToPanel(`Pesan ke ${to}: ${message}`, 'out');
            }
        });
        
        socket.on('logged-out', ({ id }) => {
            alert(`Sesi ${id} telah logout.`);
            if (activeSessionId === id) {
                activeSessionId = null;
                switchView('welcome-view');
            }
        });

        socket.on('error', (message) => {
            console.error('Error dari server:', message);
            alert(`Error: ${message}`);
        });

        // --- DOM Event Listeners ---
        newSessionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const sessionIdInput = document.getElementById('session-id-input');
            const sessionId = sessionIdInput.value.trim();
            if (sessionId) {
                socket.emit('start-session', { sessionId });
                activeSessionId = sessionId; // pre-select
                sessionIdInput.value = '';
            }
        });

        sendMessageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!activeSessionId) return alert('Pilih sesi terlebih dahulu.');
            
            const to = document.getElementById('recipient-input').value;
            const message = document.getElementById('message-input').value;
            
            socket.emit('send-message', { sessionId: activeSessionId, to, message });
            sendMessageForm.reset();
        });

        broadcastForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!activeSessionId) return alert('Pilih sesi terlebih dahulu.');

            const numbers = document.getElementById('broadcast-numbers').value.split('\n').filter(n => n.trim() !== '');
            const message = document.getElementById('broadcast-message').value;

            if(confirm(`Anda akan mengirim broadcast ke ${numbers.length} nomor. Lanjutkan?`)) {
                socket.emit('broadcast', { sessionId: activeSessionId, numbers, message });
                broadcastForm.reset();
            }
        });

        logoutBtn.addEventListener('click', () => {
             if (!activeSessionId) return alert('Pilih sesi terlebih dahulu.');
             if(confirm(`Anda yakin ingin logout dari sesi ${activeSessionId}?`)) {
                socket.emit('logout', { sessionId: activeSessionId });
             }
        });

    </script>
</body>
</html>
